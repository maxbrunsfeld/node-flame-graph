#!/usr/bin/env node

const {argv} = require('yargs')
const {
  generateFlameGraphForCommand,
  generateFlameGraphForProcess
} = require('../src/generate-flame-graph')

const pid = argv.pid || argv.p
const command = argv.command || argv.c
let functionNames = argv.function || argv.functions || argv.f

if (functionNames) functionNames = functionNames.split(/\s+/).map(name => name.trim())

async function main () {
  if (command) {
    console.log(await generateFlameGraphForCommand(command, {functionNames, fullPage: true}))
  } else if (pid) {
    const {html, stop} = generateFlameGraphForProcess(pid, {functionNames, fullPage: true})
    process.on('SIGINT', () => stop())
    console.log(await html)
    process.exit(0)
  } else {
    console.log(`Usage: ${process.argv[1]} [-c COMMAND | -p PID]`)
  }
}

main()
